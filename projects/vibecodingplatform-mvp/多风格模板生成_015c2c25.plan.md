---
name: 多风格模板生成
overview: 在 /generate 新增 style=auto|... 参数，通过“style→模板+style preprompt”双通道解耦，实现风格多变但审美稳定；并在输出根目录附带 vibe.meta.json 记录最终风格（deterministic）。
todos:
  - id: api-style-param
    content: 在 /generate 增加 style 参数，并把 style 传入模板生成链路；移除/泛化写死 Cyberpunk 的指令文案。
    status: pending
  - id: style-prompt-builder
    content: 扩展 preprompt_manager.build_system_prompt 支持按 style 选择 preprompt，并与 app_type 指南组合。
    status: pending
    dependencies:
      - api-style-param
  - id: style-auto-selector
    content: 实现 deterministic 的 style=auto 选择（颜色词/hex 优先，其次 hash 种子），并将最终选择结果用于模板与 preprompt。
    status: pending
    dependencies:
      - api-style-param
  - id: add-style-preprompts
    content: 新增至少 6 个 style preprompt 文件（不强制 class/AppShell），覆盖 aurora/glass/neo_brutal/minimal/retro_futurism/cyberpunk。
    status: pending
    dependencies:
      - style-prompt-builder
  - id: add-style-templates
    content: 基于 react-ts-shadcn 复制出至少 6 个模板变体，调整 index.css 与 ui 组件（button/card 等）以形成显著风格差异。
    status: pending
    dependencies:
      - api-style-param
  - id: emit-vibe-meta
    content: 在最终返回的 files 中写入根目录 vibe.meta.json，记录 style、来源、seed、template_name。
    status: pending
    dependencies:
      - style-auto-selector
---

# 多风格（Lovable-like）最小改造计划

## 目标与成功标准

- **目标**：让生成应用在“结构质量稳定”的同时，**风格显著多变**（不只是换色），并且用户指定颜色（如“橙色主题”）时能落到暖色系风格。
- **成功标准**：连续生成 5 个不同 prompt_text 的项目，视觉形态（圆角/直角、阴影/线框、字体、背景图形语言、按钮/卡片质感、动效节奏）明显不同；同一 prompt_text 在 `style=auto` 下多次生成得到**同一 style**；响应里包含根目录 `vibe.meta.json`。

## 现状关键点（为什么会同质化）

- 模板模式下系统提示固定注入 `preprompts_custom/cyberpunk_react`，且 `server.py` 里还写死“Follow the Cyberpunk…”，导致输出被锁到同一形态语言。

## 方案概览（双通道解耦）

- **通道 A：模板（Template）决定全局 tokens/组件质感**：为每个 style 提供一个模板目录（含 `src/index.css`、`src/components/ui/*` 等），从根上改变字体、阴影、圆角、按钮/卡片质感。
- **通道 B：style preprompt 只做“风格指南”**：每个 style 一个 preprompt，只描述色彩方向、形态语言、排版、动效节奏与布局范式，**不强制具体 class 名、不强制 AppShell**。
- **稳定性**：返回根目录 `vibe.meta.json` 记录最终 `style`（以及 seed/匹配到的颜色线索），前端后续 improve/regen 可把它读出来带回。

## 具体改动（文件级）

### 1) API：`/generate` 增加 `style`

- 修改 [`projects/vibecodingplatform-mvp/backend/server.py`](projects/vibecodingplatform-mvp/backend/server.py)：
- `POST /generate` 请求体新增 `style: str = Body(default="auto", embed=True)`
- 将 `style` 传入 `generate_with_template(prompt_text, template_name, style)`
- 将 `server.py` 内写死的 Cyberpunk 指令（如 “Follow the Cyberpunk design system …”）改为**通用**（Follow the selected style guide）或移除，避免覆盖 style preprompt。

### 2) 预提示：`build_system_prompt` 按 style 选择 preprompt

- 修改 [`projects/vibecodingplatform-mvp/backend/preprompt_manager.py`](projects/vibecodingplatform-mvp/backend/preprompt_manager.py)：
- 将 `build_system_prompt` 改为 `build_system_prompt(app_type: str, style: str)`（或保留兼容参数但不再默认强制 cyberpunk）。
- 组合策略建议：
- `system_prompt = style_preprompt(style)`
- 可选追加 `landing_page` / `dashboard` 这类“应用类型指南”（但要保证不写死某个风格）。

### 3) 模板：新增至少 6 套 style 模板（多模板/全局 tokens）

- 在 [`projects/vibecodingplatform-mvp/backend/templates/`](projects/vibecodingplatform-mvp/backend/templates/) 下新增模板目录（基于现有 `react-ts-shadcn` 复制最小改动）：
- `react-ts-shadcn-cyberpunk`
- `react-ts-shadcn-aurora`
- `react-ts-shadcn-glass`
- `react-ts-shadcn-neo-brutal`
- `react-ts-shadcn-minimal`
- `react-ts-shadcn-retro-futurism`
- 每个模板至少调整：
- `files/src/index.css`：字体引入、CSS 变量（`--primary/--background/--radius/--shadow-*`）、渐变/背景纹理 utilities
- `files/src/components/ui/button.tsx`、`card.tsx`（必要时含 `input.tsx`）：让按钮/卡片交互与质感符合风格（例如 neo-brutal 的硬边/硬阴影、minimal 的克制 hover、glass 的半透明与细边框）
- 注意：现有 `TemplateManager.merge_files` 会保留 `src/index.css` 与 `src/components/ui/`，因此“多模板”是最符合当前架构的深度改造方式。

### 4) style=auto（deterministic）选择策略

- 在 [`projects/vibecodingplatform-mvp/backend/server.py`](projects/vibecodingplatform-mvp/backend/server.py) 或新建轻量模块（如 `style_selector.py`）实现：
- **显式 style**：如果请求传了 `style != auto`，直接使用。
- **颜色优先**：若 prompt 含颜色词/hex：
- 识别暖色（橙/红/黄等）→ 从暖色友好的 styles 子集中选（例如 `retro_futurism` / `neo_brutal`）
- 识别冷色（蓝/青/紫等）→ 从冷色友好 styles 子集中选（例如 `aurora` / `glass` / `cyberpunk`）
- **否则**：用 `sha256(prompt_text_normalized)` 做种子，`seed % len(styles)` 选 style，保证可复现。

### 5) 输出元数据文件：根目录 `vibe.meta.json`

- 在模板模式最终返回 `final_files` 前，写入额外文件条目：
- 文件名：`vibe.meta.json`
- 内容建议包含：
- `style`（最终风格）
- `style_source`（explicit / color_match / hash_auto）
- `seed`（hash 或整数）
- `detected_colors`（可选，便于调试）
- `template_name`（最终使用模板）

### 6) 模板选择：style → template

- 修改 [`projects/vibecodingplatform-mvp/backend/template_manager.py`](projects/vibecodingplatform-mvp/backend/template_manager.py) 或在 `server.py` 内做映射：
- 规则建议：
- 若用户显式传 `template_name`：优先使用（兼容现有行为）
- 否则若有 `style`：使用 `style_to_template[style]`
- 否则回退 `detect_template_type(prompt_text)`

## 验证步骤（手工/自动均可）

- **多样性**：用 5 个不同 `prompt_text`（不带颜色词）调用 `/generate` 且 `style=auto`，检查返回项目的按钮/卡片/字体/背景/圆角/阴影明显不同。
- **可复现**：同一个 `prompt_text` 连续调用 3 次 `style=auto`，确认 `vibe.meta.json` 中 `style` 一致。
- **颜色意图**：`prompt_text` 包含“橙色主题/暖色系/FF7A00”等，确认 `vibe.meta.json` 中 `style` 落在暖色子集，且模板实际呈现暖色系 tokens。

## 风险与规避

- **风险：style preprompt 与模板风格不一致** → 通过“style→template 与 style→preprompt 同源映射”确保一致。
- **风险：仅改 index.css 变化不够** → 已纳入对 `src/components/ui/*` 的模板级定制，确保形态语言差异足够大。

## 预计改动清单（概览）

- 修改：`backend/server.py`、`backend/preprompt_manager.py`、`backend/template_manager.py`
- 新增：`backend/preprompts_custom/style_*`（至少 6 个）
- 新增：`backend/templates/react-ts-shadcn-*`（至少 6 个模板目录）