# 流式生成功能测试指南

## 功能概述

流式生成功能已实现，支持：
- ✅ 后端 SSE 流式推送
- ✅ 前端实时接收和显示进度
- ✅ 代码生成步骤可视化
- ✅ WebContainer 环境准备步骤集成
- ✅ 对话框中统一显示所有进度
- ✅ 数据持久化支持

## 测试场景

### 场景 1: 生成新应用（简单）

**步骤：**
1. 启动后端服务器：`cd backend && python server.py`
2. 启动前端服务器：`cd client && npm run dev`
3. 访问 http://localhost:5173
4. 点击"开始创建"，输入："创建一个待办事项应用"
5. 观察对话框中的流式进度

**预期效果：**
```
[用户消息]
创建一个待办事项应用

[AI 消息 - 流式更新]
⟳ 正在分析需求...
✓ 使用模板: react-ts-shadcn
⟳ 正在生成代码...
✓ 已生成 package.json
✓ 已生成 src/pages/Index.tsx
✓ 已生成 src/components/TodoItem.tsx
✓ 代码生成完成 (8 个文件)

⟳ 正在启动容器... (2-5秒)
✓ 挂载文件系统完成
⟳ 安装依赖中... (5-10秒)
⏱ 启动开发服务器 (等待)
```

**验证点：**
- [ ] 对话框中看到流式进度更新
- [ ] 图标使用 lucide-react（Loader2、CheckCircle2、Clock）
- [ ] 步骤按顺序完成，颜色正确
- [ ] 最终预览成功显示应用
- [ ] 刷新页面后进度仍然保存在对话历史中

### 场景 2: 改进现有应用

**步骤：**
1. 在已生成的应用基础上
2. 输入："添加一个完成按钮"
3. 观察流式进度

**预期效果：**
```
[用户消息]
添加一个完成按钮

[AI 消息 - 流式更新]
⟳ 正在分析改进需求...
⟳ 正在优化代码...
✓ 已生成 src/pages/Index.tsx
✓ 代码生成完成 (1 个文件)

⟳ 正在启动容器...
✓ 挂载文件系统完成
⟳ 安装依赖中...
✓ 启动开发服务器完成
```

**验证点：**
- [ ] 改进请求使用 /improve-stream 端点
- [ ] 步骤显示正确
- [ ] 应用更新成功
- [ ] 对话历史包含所有步骤

### 场景 3: 生成复杂应用

**步骤：**
1. 输入："创建一个 Landing Page，包含 Hero、Features、CTA 区域"
2. 观察生成进度

**预期效果：**
- 更多文件生成事件（10+ 个文件）
- 安装依赖时间更长
- 所有步骤正确显示
- 最终预览成功

**验证点：**
- [ ] 大量文件生成时不卡顿
- [ ] 步骤更新流畅
- [ ] 消息列表自动滚动到底部
- [ ] 最终应用渲染正确

### 场景 4: 错误处理

**步骤：**
1. 断开网络或停止后端服务器
2. 尝试生成应用

**预期效果：**
```
[AI 消息]
⟳ 正在分析需求...
✗ 连接失败: fetch failed
```

**验证点：**
- [ ] 显示错误步骤（红色 AlertTriangle 图标）
- [ ] 错误消息清晰
- [ ] 不会导致页面崩溃

### 场景 5: WebContainer 启动失败

**步骤：**
1. 使用不支持的浏览器（或模拟）
2. 或者在容器启动过程中模拟错误

**预期效果：**
- 代码生成成功
- 容器启动步骤失败并显示红色图标
- 显示友好的错误提示

**验证点：**
- [ ] 步骤失败状态正确显示
- [ ] 错误信息友好
- [ ] 可以重试

## 性能测试

### 测试 1: 消息更新性能

**方法：**
- 打开浏览器开发工具 Performance 面板
- 生成一个复杂应用（10+ 文件）
- 记录渲染时间

**验证点：**
- [ ] 每次步骤更新 < 16ms（60fps）
- [ ] 无明显卡顿
- [ ] 内存使用稳定

### 测试 2: 并发测试

**方法：**
- 快速连续发送多个消息
- 观察系统行为

**验证点：**
- [ ] loading 状态正确阻止并发请求
- [ ] 消息按顺序处理
- [ ] 不会出现状态混乱

## 视觉测试

### 图标和颜色

**验证点：**
- [ ] 所有图标来自 lucide-react
- [ ] 图标大小统一（18px for steps）
- [ ] 完成状态：绿色 (#22c55e)
- [ ] 进行中状态：主题色 (var(--project-accent))
- [ ] 失败状态：红色 (#ef4444)
- [ ] 等待状态：灰色 (var(--project-text-muted))

### 布局和间距

**验证点：**
- [ ] 步骤间距统一（space-y-1.5）
- [ ] 图标与文字对齐
- [ ] 时间戳位置正确
- [ ] 消息气泡大小合适（max-w-[85%]）

## 数据持久化测试

### 测试步骤：

1. 生成一个应用（等待所有步骤完成）
2. 刷新浏览器
3. 检查对话历史

**验证点：**
- [ ] 对话历史完整保存
- [ ] 所有步骤状态正确（completed/failed）
- [ ] streaming 字段为 false（已完成）
- [ ] 旧消息兼容性正常

## 已知限制

1. **不支持打字机效果**：按计划使用 chunk 粒度，直接显示完整内容
2. **步骤时长估计**：duration 字段仅供参考，实际时间可能不同
3. **WebContainer 兼容性**：移动端不支持，会显示兼容性提示

## 优化建议

### 性能优化：
- ✅ 使用 React.memo 优化 StreamingMessage 组件
- ✅ 避免不必要的状态更新
- ✅ 使用 useCallback 缓存回调函数

### 用户体验优化：
- ✅ 消息列表自动滚动
- ✅ 步骤完成时的过渡动画
- ✅ 错误状态的重试按钮

### 未来增强：
- [ ] 支持取消正在进行的生成
- [ ] 步骤耗时统计
- [ ] 进度百分比显示
- [ ] 生成日志下载

## 调试技巧

### 后端调试：
```python
# 在 server.py 中查看 SSE 输出
print(f"✓ 发送 SSE 事件: {event}")
```

### 前端调试：
```javascript
// 在 ProjectPage.jsx 中添加日志
console.log('SSE Event:', event)
console.log('AI Message Steps:', aiMsg.steps)
```

### 浏览器 Network 面板：
- 查看 /generate-stream 请求
- 确认 Content-Type: text/event-stream
- 查看 SSE 数据流

## 测试清单

### 基础功能
- [x] 后端 SSE 端点工作正常
- [x] 前端 SSE 客户端接收数据
- [x] 步骤组件渲染正确
- [x] 对话框显示流式消息
- [x] WebContainer 回调集成

### 集成测试
- [ ] 端到端生成流程
- [ ] 改进流程
- [ ] 错误处理
- [ ] 数据持久化
- [ ] 浏览器兼容性

### 性能测试
- [ ] 渲染性能
- [ ] 内存使用
- [ ] 并发处理

### 视觉测试
- [ ] 图标正确
- [ ] 颜色一致
- [ ] 布局合理
- [ ] 响应式设计

## 测试结果

测试日期：____________

测试人员：____________

测试环境：
- 浏览器：____________
- Node.js 版本：____________
- Python 版本：____________

### 通过的测试：


### 失败的测试：


### 需要修复的问题：


### 备注：



